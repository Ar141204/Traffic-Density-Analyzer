{% extends "base.html" %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/result.css') }}">
{% endblock %}

{% block title %}Traffic Analysis Dashboard{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">Traffic Analysis Dashboard</h1>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="info-box bg-custom rounded-custom shadow-custom p-4">
                <h3>{{ analysis.vehicle_count }}</h3>
                <p class="text-muted mb-0">Total Vehicles</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box bg-custom rounded-custom shadow-custom p-4">
                <h3>{{ "%.1f"|format(analysis.density_percentage) }}%</h3>
                <p class="text-muted mb-0">Current Density</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box bg-custom rounded-custom shadow-custom p-4">
                <h3>{{ "%.1f"|format(analysis.density_percentage) }}%</h3>
                <p class="text-muted mb-0">Peak Density</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box bg-custom rounded-custom shadow-custom p-4">
                {% set duration = 1 if not analysis.processed_at else (analysis.processed_at - analysis.processed_at).seconds %}
                <h3>{{ "%.1f"|format(analysis.vehicle_count / duration if duration > 0 else 0) }}</h3>
                <p class="text-muted mb-0">Vehicles/Second</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Traffic Feed -->
        <div class="col-md-8 mb-4">
            <div class="bg-custom rounded-custom shadow-custom p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Traffic Feed</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" id="toggleAnnotations">
                            <i class="fas fa-box me-1"></i>Toggle Annotations
                        </button>
                        <button class="btn btn-primary" id="playPauseBtn">
                            <i class="fas fa-play me-1"></i>Play/Pause
                        </button>
                        {% if analysis.file_type == 'video' %}
                        <a href="{{ url_for('static', filename='results/' + analysis.result_path) }}" 
                           class="btn btn-success" 
                           download="{{ analysis.filename }}"
                           title="Download processed video">
                            <i class="fas fa-download me-1"></i>Download Video
                        </a>
                        {% else %}
                        <a href="{{ url_for('static', filename='results/' + analysis.result_path) }}" 
                           class="btn btn-success" 
                           download="{{ analysis.filename }}"
                           title="Download processed image">
                            <i class="fas fa-download me-1"></i>Download Image
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% if analysis.file_type == 'video' %}
                <div class="video-container">
                    <video id="resultVideo" controls>
                        <source src="{{ url_for('static', filename='results/' + analysis.result_path) }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <div class="video-overlay" id="videoOverlay">
                        <!-- Lane Statistics -->
                        <div class="lane-stats-container">
                            <div class="lane-stats left-lane">
                                <div class="lane-title">Left Lane</div>
                                <div class="vehicle-count">Vehicles: <span id="leftLaneCount">0</span></div>
                                <div class="density">Density: <span id="leftLaneDensity">0</span>%</div>
                            </div>
                            <div class="lane-stats right-lane">
                                <div class="lane-title">Right Lane</div>
                                <div class="vehicle-count">Vehicles: <span id="rightLaneCount">0</span></div>
                                <div class="density">Density: <span id="rightLaneDensity">0</span>%</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="image-container">
                    <img src="{{ url_for('static', filename='results/' + analysis.result_path) }}" 
                         alt="Analysis Result" 
                         class="img-fluid">
                    <div class="image-overlay">
                        <!-- Lane Statistics -->
                        <div class="lane-stats-container">
                            <div class="lane-stats left-lane">
                                <div class="lane-title">Left Lane</div>
                                <div class="vehicle-count">Vehicles: {{ analysis.left_lane_count }}</div>
                                <div class="density">Density: {{ "%.1f"|format(analysis.left_lane_density) }}%</div>
                            </div>
                            <div class="lane-stats right-lane">
                                <div class="lane-title">Right Lane</div>
                                <div class="vehicle-count">Vehicles: {{ analysis.right_lane_count }}</div>
                                <div class="density">Density: {{ "%.1f"|format(analysis.right_lane_density) }}%</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Vehicle Distribution -->
        <div class="col-md-4 mb-4">
            <div class="bg-custom rounded-custom shadow-custom p-4">
                <h2>Vehicle Distribution</h2>
                <canvas id="vehicleChart"></canvas>
                <div class="mt-3 text-center">
                    <p class="mb-1">Most Common: Cars ({{ analysis.car_count }})</p>
                    <p class="mb-0">Least Common: Trucks ({{ analysis.truck_count }})</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Traffic Flow Analysis -->
        <div class="col-md-8 mb-4">
            <div class="bg-custom rounded-custom shadow-custom p-4">
                <h2>Traffic Flow Analysis</h2>
                <div class="d-flex align-items-center mb-3">
                    <span class="badge bg-{{ 'danger' if analysis.density_percentage > 75 else 'warning' if analysis.density_percentage > 50 else 'success' }} me-2">
                        {{ "Heavy Traffic" if analysis.density_percentage > 75 else "Moderate Flow" if analysis.density_percentage > 50 else "Light Traffic" }}
                    </span>
                    {% if analysis.motorcycle_count == 0 %}
                    <span class="badge bg-info me-2" title="No motorcycles detected in this analysis">No Motorcycles</span>
                    {% endif %}
                    {% if low_confidence %}
                    <span class="badge bg-warning text-dark" title="Average detection confidence is low; consider re-running with a higher threshold">Low Confidence</span>
                    {% endif %}
                </div>
                <canvas id="trafficFlowChart"></canvas>
                <div class="mt-3">
                    <h5 class="mb-2">Density Over Time</h5>
                    <canvas id="densityTimeline"></canvas>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-4">
            <!-- Traffic Recommendations -->
            <div class="bg-custom rounded-custom shadow-custom p-4 mb-4">
                <h2>Traffic Recommendations</h2>
                <div class="alert {{ 'alert-danger' if analysis.density_percentage > 75 else 'alert-warning' if analysis.density_percentage > 50 else 'alert-info' }} mb-0">
                    {% if analysis.density_percentage > 75 %}
                        Heavy congestion detected. Consider alternate routes.
                    {% elif analysis.density_percentage > 50 %}
                        Moderate traffic volume. Expect minor delays.
                    {% else %}
                        Traffic flow is optimal. Good time to travel.
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-custom rounded-custom shadow-custom p-4 sticky-actions">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">Quick Actions</h2>
                    <div class="btn-group">
                       <button class="btn btn-outline-light btn-sm" data-bs-toggle="offcanvas" data-bs-target="#detailsPanel"><i class="fas fa-sliders-h"></i></button>
                       <button class="btn btn-outline-light btn-sm" data-bs-toggle="offcanvas" data-bs-target="#rerunPanel" title="Re-run with thresholds"><i class="fas fa-repeat"></i></button>
                    </div>
                </div>
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-primary" onclick="downloadReport()">
                        <i class="fas fa-download me-2"></i>Download Report
                    </button>
                    <button class="btn btn-primary" onclick="shareResults()">
                        <i class="fas fa-share-alt me-2"></i>Share Analysis
                    </button>
                    <button class="btn btn-primary" onclick="compareHistorical()">
                        <i class="fas fa-history me-2"></i>Compare Historical
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Offcanvas right panel -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="detailsPanel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Details & Downloads</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <ul class="nav nav-tabs metrics-tabs mb-3" role="tablist">
      <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-details" type="button" role="tab">Details</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-downloads" type="button" role="tab">Downloads</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-notes" type="button" role="tab">Notes</button></li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="tab-details" role="tabpanel">
        <p><strong>File:</strong> {{ analysis.filename }}</p>
        <p><strong>Total Vehicles:</strong> {{ analysis.vehicle_count }}</p>
        <p><strong>Density:</strong> {{ "%.1f"|format(analysis.density_percentage) }}%</p>
      </div>
      <div class="tab-pane fade" id="tab-downloads" role="tabpanel">
        <a class="btn btn-sm btn-primary me-2" href="{{ url_for('download_file', filename=analysis.result_path) }}"><i class="fas fa-video me-1"></i>Processed Media</a>
        {% if analysis.id %}
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_report', analysis_id=analysis.id) }}"><i class="fas fa-file-csv me-1"></i>CSV Report</a>
        {% endif %}
      </div>
      <div class="tab-pane fade" id="tab-notes" role="tabpanel">
        <textarea class="form-control" rows="4" placeholder="Add notes..."></textarea>
      </div>
    </div>
  </div>
</div>

<!-- Re-run thresholds panel -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="rerunPanel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Re-run with thresholds</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div class="mb-3">
      <label class="form-label">Global Confidence</label>
      <input type="range" class="form-range" id="confGlobal" min="0.1" max="0.9" step="0.05" value="0.6">
    </div>
    <div class="mb-3">
      <label class="form-label">Motorcycle Confidence</label>
      <input type="range" class="form-range" id="confMoto" min="0.1" max="0.95" step="0.05" value="0.75">
    </div>
    <div class="mb-3">
      <label class="form-label">IOU Match Threshold</label>
      <input type="range" class="form-range" id="iouThresh" min="0.1" max="0.7" step="0.05" value="0.3">
    </div>
    <div class="alert alert-info">Re-run is available when you upload again; these values will be sent along with the upload for processing.</div>
  </div>
  <div class="offcanvas-footer p-3 border-top">
    <button class="btn btn-primary w-100" onclick="savePreset()"><i class="fas fa-save me-1"></i>Save as Preset</button>
  </div>
</div>

<!-- Mobile command bar -->
<div class="d-md-none fixed-bottom command-bar p-2">
  <div class="container d-flex justify-content-around">
    <a href="/" class="btn btn-outline-light"><i class="fas fa-upload"></i></a>
    <button class="btn btn-outline-light" onclick="shareResults()"><i class="fas fa-share-alt"></i></button>
    {% if analysis.id %}
    <a href="{{ url_for('download_report', analysis_id=analysis.id) }}" class="btn btn-outline-light"><i class="fas fa-file-download"></i></a>
    {% endif %}
    <a href="{{ url_for('history') }}" class="btn btn-outline-light"><i class="fas fa-clock"></i></a>
  </div>
</div>

<div id="analysis-data" 
     data-id="{{ analysis.id if analysis.id else '' }}"
     data-filename="{{ analysis.filename|tojson|safe }}"
     data-vehicle-count="{{ analysis.vehicle_count|tojson|safe }}"
     data-density="{{ "%.2f"|format(analysis.density_percentage)|tojson|safe }}"
     data-car-count="{{ analysis.car_count|tojson|safe }}"
     data-truck-count="{{ analysis.truck_count|tojson|safe }}"
     data-bus-count="{{ analysis.bus_count|tojson|safe }}"
     data-motorcycle-count="{{ analysis.motorcycle_count|tojson|safe }}">
</div>
<!-- Density series JSON (for JS to parse) -->
<script id="density-data" type="application/json">{{ (density_series or [])|tojson }}</script>
{% endblock %}

{% block scripts %}
<script>
    // Vehicle Distribution Chart
    const analysisEl = document.getElementById('analysis-data');
    // Skeleton demo (briefly) for perceived performance
    const metricBoxes = document.querySelectorAll('.info-box');
    metricBoxes.forEach(b => b.classList.add('skeleton'));
    setTimeout(() => metricBoxes.forEach(b => b.classList.remove('skeleton')), 600);
    const carCount = parseInt(analysisEl.dataset.carCount || '0', 10);
    const truckCount = parseInt(analysisEl.dataset.truckCount || '0', 10);
    const busCount = parseInt(analysisEl.dataset.busCount || '0', 10);
    const motorcycleCount = parseInt(analysisEl.dataset.motorcycleCount || '0', 10);

    // Preset save helper
    function savePreset(){
      const preset = {
        conf_global: parseFloat(document.getElementById('confGlobal').value),
        motorcycle_conf: parseFloat(document.getElementById('confMoto').value),
        iou_thresh: parseFloat(document.getElementById('iouThresh').value)
      };
      localStorage.setItem('processingPreset', JSON.stringify(preset));
      alert('Preset saved. Next upload will use these thresholds.');
    }

    // KPI count-up
    function countUp(el, to, duration=900) {
      const start = performance.now();
      const from = 0;
      function step(ts){
        const p = Math.min(1, (ts-start)/duration);
        el.textContent = Math.floor(from + (to-from)*p);
        if (p<1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }
    const kpiEls = document.querySelectorAll('.info-box h3');
    if (kpiEls[0]) countUp(kpiEls[0], parseInt(analysisEl.dataset.vehicleCount||'0',10));

    // Chart gradient + datalabels
    const vehicleCtx = document.getElementById('vehicleChart').getContext('2d');
    const gradient = vehicleCtx.createLinearGradient(0,0,0,180);
    gradient.addColorStop(0,'rgba(78,161,255,0.9)');
    gradient.addColorStop(1,'rgba(78,161,255,0.2)');
    new Chart(vehicleCtx, {
        type: 'doughnut',
        data: {
            labels: ['Cars', 'Motorcycles', 'Buses', 'Trucks'],
            datasets: [{
                data: [carCount, motorcycleCount, busCount, truckCount],
                backgroundColor: [gradient,'rgba(75,192,192,0.8)','rgba(255,206,86,0.8)','rgba(255,99,132,0.8)']
            }]
        },
        options: {
            responsive: true,
            cutout: '70%',
            plugins: {
                legend: { position: 'bottom' },
                datalabels: {
                   color: '#fff',
                   formatter: (v,ctx)=> v>0? v: '',
                   font: { weight: '600' }
                }
            }
        }
    });

    // Traffic Flow Chart with gradient
    const flowCtx = document.getElementById('trafficFlowChart').getContext('2d');
    const g2 = flowCtx.createLinearGradient(0,0,0,200);
    g2.addColorStop(0,'rgba(78,161,255,0.5)');
    g2.addColorStop(1,'rgba(78,161,255,0.05)');
    new Chart(flowCtx, {
        type: 'line',
        data: {
            labels: Array.from({length: 20}, (_, i) => i + 1),
            datasets: [{
                label: 'Traffic Flow Rate',
                data: Array.from({length: 20}, () => Math.random() * 30),
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: g2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, max: 50 }},
            plugins: { legend: { display: false }, datalabels: { display: false } }
        }
    });

    // Density timeline synced to video time
    const densityDataEl = document.getElementById('density-data');
    let densitySeries = [];
    try { densitySeries = densityDataEl ? JSON.parse(densityDataEl.textContent || '[]') : []; } catch(e) { densitySeries = []; }
    const videoEl = document.getElementById('resultVideo');
    const dtCanvas = document.getElementById('densityTimeline');
    const dtCtx = dtCanvas ? dtCanvas.getContext('2d') : null;
    const dtChart = dtCtx ? new Chart(dtCtx, {
      type: 'line',
      data: {
        labels: densitySeries.map((_,i)=> i),
        datasets: [{
          label: 'Density %',
          data: densitySeries,
          borderColor: 'rgba(255,99,132,1)',
          backgroundColor: 'rgba(255,99,132,0.15)',
          fill: true,
          tension: 0.25,
          pointRadius: 0
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false }}, scales: { y: { min:0, max:100 }}}
    }) : null;
    // Scrub: when clicking the chart, jump video
    if (dtCanvas && dtChart) {
      dtCanvas.onclick = (evt) => {
        if (!videoEl) return;
        const points = dtChart.getElementsAtEventForMode(evt, 'nearest', { intersect: false }, true);
        if (points && points[0]) {
          const idx = points[0].index;
          const ratio = idx / Math.max(1,(densitySeries.length-1));
          if (!isNaN(videoEl.duration)) videoEl.currentTime = ratio * videoEl.duration;
        }
      };
    }
    // Update active indicator as video plays (optional)
    if (videoEl && dtChart) {
      videoEl.addEventListener('timeupdate', ()=>{
        if (isNaN(videoEl.duration) || !densitySeries.length) return;
        const idx = Math.min(densitySeries.length-1, Math.floor((videoEl.currentTime / videoEl.duration) * densitySeries.length));
        dtChart.setActiveElements([{datasetIndex:0, index: idx}]);
        dtChart.update('none');
      });
    }

    // Initialize video player and controls
    document.addEventListener('DOMContentLoaded', function() {
        const video = document.getElementById('resultVideo');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const toggleAnnotationsBtn = document.getElementById('toggleAnnotations');
        const videoOverlay = document.getElementById('videoOverlay');
        
        if (video) {
            // Set initial video properties
            video.preload = 'auto';
            
            // Update play/pause button on video state change
            video.addEventListener('play', () => {
                playPauseBtn.innerHTML = '<i class="fas fa-pause me-1"></i>Pause';
            });
            
            video.addEventListener('pause', () => {
                playPauseBtn.innerHTML = '<i class="fas fa-play me-1"></i>Play';
            });

            // Play/Pause button click handler
            playPauseBtn.addEventListener('click', () => {
                if (video.paused) {
                    video.play().catch(e => {
                        console.error('Error playing video:', e);
                        alert('Error playing video. Please try again.');
                    });
                } else {
                    video.pause();
                }
            });

            // Toggle annotations button click handler
            let showAnnotations = true;
            toggleAnnotationsBtn.addEventListener('click', () => {
                showAnnotations = !showAnnotations;
                videoOverlay.style.display = showAnnotations ? 'block' : 'none';
                toggleAnnotationsBtn.innerHTML = showAnnotations ? 
                    '<i class="fas fa-eye-slash me-1"></i>Hide Annotations' : 
                    '<i class="fas fa-eye me-1"></i>Show Annotations';
            });

            // Update lane statistics during video playback (placeholder)
            video.addEventListener('timeupdate', () => {
                if (showAnnotations) {
                    document.getElementById('leftLaneCount').textContent = 
                        Math.floor(Math.random() * 10 + 5);
                    document.getElementById('rightLaneCount').textContent = 
                        Math.floor(Math.random() * 10 + 5);
                    document.getElementById('leftLaneDensity').textContent = 
                        (Math.random() * 30 + 20).toFixed(1);
                    document.getElementById('rightLaneDensity').textContent = 
                        (Math.random() * 30 + 20).toFixed(1);
                }
            });

            // Error handling for video
            video.addEventListener('error', (e) => {
                console.error('Video error:', e);
                alert('Error loading video. Please check if the video file exists and try again.');
            });
        }
    });

    function downloadReport() {
        const id = analysisEl.dataset.id;
        if (!id) {
            alert('Report is only available for saved analyses.');
            return;
        }
        window.location.href = `/report/${id}`;
    }

    async function shareResults() {
        const shareData = {
            title: 'Traffic Analysis Results',
            text: 'Analysis Results for ' + analysisEl.dataset.filename + ' - ' +
                  'Total Vehicles: ' + analysisEl.dataset.vehicleCount + ' - ' +
                  'Traffic Density: ' + analysisEl.dataset.density + '%',
            url: window.location.href
        };

        try {
            if (navigator.share) {
                await navigator.share(shareData);
            } else {
                await navigator.clipboard.writeText(shareData.text);
                alert('Results copied to clipboard!');
            }
        } catch (err) {
            console.error('Error sharing:', err);
            alert('Could not share results');
        }
    }

    function compareHistorical() {
        console.log('Compare historical clicked');
    }
</script>
{% endblock %}